<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Leads Profissional - H√≠brido</title>
    <link rel="stylesheet" href="style.css">
    <!-- √çcones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Biblioteca para Exportar Excel (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>

    <!-- SISTEMA DE LOGIN -->
    <section id="auth-section">
        <div class="auth-container">
            <div class="auth-box" id="login-box">
                <h2>Acesso ao Sistema</h2>
                <p>Gerador de Leads Profissional</p>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Seu e-mail" required>
                    <input type="password" id="login-password" placeholder="Sua senha" required>
                    <button type="submit" class="btn-primary">Entrar</button>
                </form>
                <div class="auth-links">
                    <a href="#" id="link-register">Criar conta</a> | 
                    <a href="#" id="link-forgot">Esqueci minha senha</a>
                </div>
            </div>

            <div class="auth-box hidden" id="register-box">
                <h2>Criar Conta</h2>
                <form id="register-form">
                    <!-- SELETOR DE MODO (Apenas no Cadastro) -->
                    <div class="mode-selector-container">
                        <label for="register-mode-select" class="mode-label">Definir Modo de Opera√ß√£o:</label>
                        <select id="register-mode-select" class="mode-select">
                            <option value="local" selected>Local (Offline) - Recomendado</option>
                            <option value="hybrid">H√≠brido (Local + Nuvem)</option>
                            <option value="cloud">Nuvem (Firebase)</option>
                        </select>
                    </div>

                    <input type="text" id="reg-name" placeholder="Seu Nome Completo" required>
                    <input type="email" id="reg-email" placeholder="Seu e-mail" required>
                    <input type="password" id="reg-password" placeholder="Crie uma senha" required>
                    <button type="submit" class="btn-primary">Cadastrar</button>
                </form>
                <div class="auth-links">
                    <a href="#" id="link-login-reg">Voltar para Login</a>
                </div>
            </div>

            <div class="auth-box hidden" id="forgot-box">
                <h2>Recuperar Senha</h2>
                <p>Informe seu e-mail para receber as instru√ß√µes (Apenas Nuvem/H√≠brido).</p>
                <form id="forgot-form">
                    <input type="email" id="forgot-email" placeholder="E-mail cadastrado" required>
                    <button type="submit" class="btn-primary">Recuperar</button>
                </form>
                <div class="auth-links">
                    <a href="#" id="link-login-forgot">Voltar para Login</a>
                </div>
            </div>
        </div>
    </section>

    <!-- APLICA√á√ÉO PRINCIPAL (Vis√≠vel apenas ap√≥s login) -->
    <section id="app-section" class="hidden">
        <header>
            <div class="header-content">
                <div class="user-info">
                    <span>Ol√°, <strong id="user-name-display">Visitante</strong></span>
                </div>
                <div class="header-actions">
                    <!-- Bot√£o Meus Contatos -->
                    <button id="btn-show-saved-leads" class="btn-primary-outline">
                        <i class="fas fa-address-book"></i> Meus Contatos
                    </button>

                    <!-- Bot√µes Admin (Invis√≠veis por padr√£o) -->
                    <button id="btn-admin-add" class="btn-outline btn-admin-success hidden">
                        <i class="fas fa-plus-circle"></i> +10 Leads
                    </button>
                    <button id="btn-admin-reset" class="btn-outline btn-admin-danger hidden">
                        <i class="fas fa-trash"></i> Zerar Saldo
                    </button>
                    
                    <button id="btn-config" class="btn-secondary"><i class="fas fa-cog"></i> Configura√ß√µes</button>
                    <button id="btn-logout" class="btn-outline">Sair</button>
                </div>
            </div>
        </header>

        <main>
            <div class="search-panel">
                <h1>Filtro de Leads (ICP)</h1>
                <p>Localize potenciais clientes e gere oportunidades reais.</p>
                
                <form id="lead-search-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="niche">Nicho / Profiss√£o</label>
                            <input type="text" id="niche" placeholder="Ex: Restaurantes, Advogados..." required>
                        </div>
                        <div class="form-group">
                            <label for="city">Cidade</label>
                            <input type="text" id="city" placeholder="Ex: S√£o Paulo">
                        </div>
                        <div class="form-group">
                            <label for="state">Estado (UF)</label>
                            <select id="state">
                                <option value="">Todos</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="limit">Quantidade (M√°x 100)</label>
                            <input type="number" id="limit" value="100" min="1" max="100">
                        </div>
                    </div>

                    <!-- SELE√á√ÉO DE TEMPLATE NA BUSCA -->
                    <div class="form-group template-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label for="message-template-input">Mensagem de Abordagem (Edit√°vel)</label>
                            <small class="input-hint" style="margin:0;">Vari√°veis: {nicho}, {cidade}, {estado}</small>
                        </div>
                        <textarea id="message-template-input" rows="8"></textarea>
                        <div class="template-controls-mini">
                            <button type="button" id="btn-load-default-msg" class="btn-action">Restaurar Texto Padr√£o</button>
                        </div>
                    </div>

                    <!-- Bot√£o de Busca -->
                    <button type="submit" id="btn-search-leads" class="btn-primary full-width"><i class="fas fa-search"></i> Buscar Leads</button>
                    
                    <!-- Bot√£o Salvar Leads -->
                    <button type="button" id="btn-save-db-direct" class="btn-success full-width" style="margin-top: 10px;">
                        <i class="fas fa-save"></i> Salvar Leads
                    </button>
                </form>
                
                <!-- Status da API / Leads -->
                <div id="api-status-warning" class="warning-box hidden">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <span id="api-warning-text">Chave API n√£o configurada. Exibindo <strong>leads fict√≠cios</strong>.</span>
                </div>
                
                <div id="api-status-success" class="success-box hidden">
                    <i class="fas fa-database"></i> 
                    <span style="flex:1;">API Ativa (<span id="api-provider-badge">Serper</span>). <strong>Saldo de Leads: <span id="leads-balance-display">0</span></strong></span>
                </div>

                <div id="api-status-expired" class="error-box hidden">
                    <i class="fas fa-ban"></i> 
                    <span>Saldo de Leads Esgotado (0). Modo Simula√ß√£o Ativo. <button id="btn-revalidate-trigger" class="btn-link">Recarregar</button></span>
                </div>
            </div>

            <div class="results-panel hidden" id="results-panel">
                <div class="results-header">
                    <!-- T√≠tulo Edit√°vel dinamicamente -->
                    <h2 id="results-title">Resultados <span id="data-source-badge" class="badge-fictitious">(Simulados)</span>: <span id="result-count">0</span></h2>
                    <!-- BOT√ïES DE EXPORTA√á√ÉO DA BUSCA ATUAL -->
                    <div class="export-buttons">
                        <button id="btn-export-csv" class="btn-outline btn-sm"><i class="fas fa-file-csv"></i> Baixar CSV</button>
                        <button id="btn-export-xlsx" class="btn-outline btn-sm"><i class="fas fa-file-excel"></i> Baixar Excel</button>
                    </div>
                </div>

                <!-- √ÅREA DE FILTROS -->
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="filter-text">Buscar (Nome/Geral)</label>
                        <input type="text" id="filter-text" placeholder="Digite para filtrar...">
                    </div>
                    <div class="filter-group">
                        <label for="filter-status">Status</label>
                        <select id="filter-status">
                            <option value="">Todos</option>
                            <option value="Novo">Novo</option>
                            <option value="Contatado">Contatado</option>
                            <option value="Interessado">Interessado</option>
                            <option value="Negocia√ß√£o">Negocia√ß√£o</option>
                            <option value="Convertido">Convertido</option>
                            <option value="N√£o interessado">N√£o interessado</option>
                            <option value="Telefone sem WhatsApp">Telefone sem WhatsApp</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-niche">Nicho</label>
                        <select id="filter-niche">
                            <option value="">Todos</option>
                            <!-- Preenchido via JS -->
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="leads-table">
                        <thead>
                            <tr>
                                <th>Empresa / Status</th>
                                <th>Detalhes (Nicho, Local)</th>
                                <th>Contato</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="leads-body">
                            <!-- Leads ser√£o inseridos aqui -->
                        </tbody>
                    </table>
                </div>

                <!-- Container de Pagina√ß√£o -->
                <div id="pagination-controls" class="pagination-container hidden">
                    <!-- Bot√µes gerados via JS -->
                </div>
            </div>
        </main>

        <!-- Modal de Configura√ß√£o -->
        <div id="config-modal" class="modal hidden">
            <div class="modal-content large-modal">
                <span class="close-modal">&times;</span>
                <h3>Configura√ß√µes do Sistema</h3>
                
                <div class="config-tabs">
                    <button class="tab-btn active" data-tab="tab-api">API & Leads</button>
                    <button class="tab-btn" data-tab="tab-templates">Cadastrar Textos</button>
                    <!-- ABA BACKUP -->
                    <button class="tab-btn" data-tab="tab-data">Dados & Backup</button>
                </div>

                <!-- TAB API -->
                <div id="tab-api" class="tab-content active">
                    <div class="config-section">
                        <h4>Configura√ß√£o da API de Busca</h4>
                        <p>Selecione qual chave de API deseja utilizar para buscar dados reais.</p>
                        
                        <div class="form-group">
                            <label for="api-provider-select">Selecione a Chave:</label>
                            <select id="api-provider-select" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="">-- Selecionar --</option>
                                <option value="KEY_1">Chave 1</option> 
                                <option value="KEY_2">Chave 2</option>
                            </select>
                        </div>
                        
                        <button id="save-api-key" class="btn-primary" style="margin-top: 10px;">Salvar Prefer√™ncia</button>
                        <p id="api-validation-msg" class="validation-msg"></p>
                    </div>

                    <div id="revalidation-area" class="config-section hidden revalidation-box">
                        <h4>üíé Recarga de Leads (Senha/Contra-Senha)</h4>
                        <p>Para adicionar leads ao seu saldo, siga os passos:</p>
                        
                        <div class="recharge-steps">
                            <div class="step-box">
                                <label>1. C√≥digo Gerado:</label>
                                <div class="challenge-row">
                                    <strong id="challenge-number" class="highlight-number">---</strong>
                                    <button id="btn-generate-challenge" class="btn-secondary btn-sm">Gerar</button>
                                </div>
                            </div>
                            <div class="step-box">
                                <label>2. Quero adquirir (Qtd):</label>
                                <input type="number" id="leads-quantity" placeholder="Ex: 500" min="1">
                            </div>
                            <div class="step-box full">
                                <label>3. Solicitar Contra-senha:</label>
                                <a href="#" id="btn-whatsapp-request" target="_blank" class="btn-whatsapp">
                                    <i class="fab fa-whatsapp"></i> Enviar C√≥digo e Pedido via WhatsApp
                                </a>
                            </div>
                            <div class="step-box full">
                                <label>4. Inserir Contra-senha:</label>
                                <div class="response-box">
                                    <input type="text" id="challenge-response" placeholder="Ex: 12345-500">
                                    <button id="btn-verify-challenge" class="btn-primary">Ativar Leads</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB TEMPLATES -->
                <div id="tab-templates" class="tab-content">
                    <div class="config-section">
                        <h4>Gerenciar Modelos de Mensagem</h4>
                        <div class="new-template-form">
                            <input type="text" id="new-template-name" placeholder="Nome do Modelo (ex: Abordagem Formal)">
                            <textarea id="new-template-content" rows="6" placeholder="Texto da mensagem com vari√°veis {nicho}, {cidade}..."></textarea>
                            <button id="btn-save-template" class="btn-secondary">Adicionar Modelo</button>
                        </div>
                        <div class="templates-list-container">
                            <h5>Modelos Salvos</h5>
                            <ul id="templates-list" class="templates-list"></ul>
                        </div>
                    </div>
                </div>

                <!-- TAB DADOS & BACKUP (NOVO) -->
                <div id="tab-data" class="tab-content">
                    <div class="config-section">
                        <h4>Gest√£o de Dados Locais</h4>
                        <p>Gerencie seus dados salvos no navegador (Modo Local/H√≠brido).</p>
                        
                        <div class="backup-actions">
                            <button id="btn-backup" class="btn-backup">
                                <i class="fas fa-download"></i> Fazer Backup (Download)
                            </button>
                            
                            <button id="btn-restore-trigger" class="btn-restore">
                                <i class="fas fa-upload"></i> Restaurar Dados
                            </button>
                            <!-- Input oculto para upload -->
                            <input type="file" id="restore-file-input" accept=".json" class="hidden">
                        </div>
                        
                        <p class="input-hint" style="margin-top: 10px;">
                            * O Backup gera um arquivo .json com seus leads, saldo e templates.<br>
                            * A Restaura√ß√£o ir√° substituir os dados locais atuais.
                        </p>
                    </div>
                </div>

            </div>
        </div>

        <!-- MODAL: Gerenciar Banco de Leads -->
        <div id="database-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal-db">&times;</span>
                <h3>üì¶ Gerenciar Banco de Dados</h3>
                <p>Selecione um nicho para baixar e remover do banco de dados.</p>
                
                <div class="db-filter-box">
                    <label for="db-niche-select">Filtrar por Nicho salvo:</label>
                    <select id="db-niche-select">
                        <option value="">Carregando nichos...</option>
                    </select>
                </div>

                <div class="db-actions">
                    <button id="btn-download-delete-csv" class="btn-action-db btn-csv">
                        <i class="fas fa-file-csv"></i> Baixar CSV e Limpar
                    </button>
                    <button id="btn-download-delete-xlsx" class="btn-action-db btn-excel">
                        <i class="fas fa-file-excel"></i> Baixar Excel e Limpar
                    </button>
                </div>
                
                <div id="db-status-msg" class="validation-msg" style="margin-top:10px;"></div>
            </div>
        </div>

        <!-- MODAL: Detalhes e Gerenciamento do Lead -->
        <div id="lead-details-modal" class="modal hidden">
            <div class="modal-content large-modal">
                <span class="close-modal-details">&times;</span>
                <h3><i class="fas fa-user-edit"></i> Gerenciar Lead</h3>
                
                <div class="lead-details-grid">
                    <div class="detail-header">
                        <h2 id="detail-name">Nome do Neg√≥cio</h2>
                        <span id="detail-niche-badge" class="badge-niche">Nicho</span>
                    </div>

                    <div class="detail-section">
                        <h4>üìû Contato</h4>
                        <div class="detail-row">
                            <strong>Telefone / WhatsApp:</strong>
                            <span id="detail-phone">...</span>
                        </div>
                        <div class="detail-row">
                            <strong>Website:</strong>
                            <a href="#" id="detail-website" target="_blank">...</a>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üìå Observa√ß√µes</h4>
                        <div class="detail-row-grid">
                            <div>‚≠ê Avalia√ß√£o: <span id="detail-rating">...</span></div>
                            <div>üìù Total de avalia√ß√µes: <span id="detail-rating-count">...</span></div>
                            <div>üìç Atividade: <span id="detail-activity">...</span></div>
                        </div>
                        <div class="detail-address-box">
                            <strong>üè¢ Endere√ßo:</strong>
                            <p id="detail-address">...</p>
                        </div>
                    </div>

                    <div class="detail-section highlight-section">
                        <h4>üóÇÔ∏è Gerenciar Lead</h4>
                        <div class="form-group">
                            <label for="detail-status">Status do Lead:</label>
                            <select id="detail-status">
                                <option value="Novo">Novo</option>
                                <option value="Contatado">Contatado</option>
                                <option value="Interessado">Interessado</option>
                                <option value="Negocia√ß√£o">Negocia√ß√£o</option>
                                <option value="Convertido">Convertido</option>
                                <option value="N√£o interessado">N√£o interessado</option>
                                <option value="Telefone sem WhatsApp">Telefone sem WhatsApp</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="detail-notes">Notas de Follow-up:</label>
                            <textarea id="detail-notes" rows="4" placeholder="Adicione observa√ß√µes sobre o contato, pr√≥ximos passos..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="btn-cancel-details" class="btn-outline">Cancelar</button>
                    <button id="btn-save-details" class="btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </div>
        </div>

        <!-- Modal de Abordagem -->
        <div id="message-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal-msg">&times;</span>
                <h3>Gerador de Abordagem</h3>
                
                <!-- NOVO: Seletor de Modelo no Modal (Item 1) -->
                <div style="margin-bottom: 5px;">
                    <label for="modal-template-select" style="font-size:0.9rem; color:var(--text-muted);">Selecionar Modelo:</label>
                    <select id="modal-template-select" class="modal-template-selector">
                        <!-- Op√ß√µes carregadas via JS -->
                    </select>
                </div>

                <div class="message-box">
                    <textarea id="generated-message" rows="8"></textarea>
                </div>

                <button id="copy-message" class="btn-secondary">
                    <i class="far fa-copy"></i> Copiar Mensagem
                </button>
                
                <a id="btn-send-whatsapp" href="#" target="_blank" class="btn-whatsapp-action">Enviar no WhatsApp</a>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 Gerador de Leads Profissional. Todos os direitos reservados.</p>
            <a href="https://www.websitelog.com.br" target="_blank">www.websitelog.com.br</a>
        </footer>
    </section>

    <script src="script.js"></script>
</body>
</html>
